name: Auto Fix Cloud Android

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Apply autofix
        run: |
          echo "ðŸ”§ Patching Dockerfile, start.sh, docker-compose.yml"
          
          # à¹€à¸‚à¸µà¸¢à¸™à¹„à¸Ÿà¸¥à¹Œ Dockerfile
          cat > cloud-android/Dockerfile <<'EOF'
          FROM ubuntu:20.04

          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && apt-get install -y \
              wget unzip openjdk-11-jdk \
              libgl1-mesa-dev libx11-6 xvfb x11vnc fluxbox \
              novnc websockify \
              && rm -rf /var/lib/apt/lists/*

          # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Android SDK
          RUN mkdir -p /opt/android-sdk && cd /opt \
              && wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O cmdline-tools.zip \
              && unzip cmdline-tools.zip -d android-sdk \
              && rm cmdline-tools.zip

          ENV ANDROID_HOME=/opt/android-sdk
          ENV PATH=$ANDROID_HOME/cmdline-tools/bin:$ANDROID_HOME/platform-tools:$PATH

          RUN yes | sdkmanager --licenses || true
          RUN sdkmanager "platform-tools" "platforms;android-30" "system-images;android-30;google_apis;x86_64" "emulator"

          # à¸ªà¸£à¹‰à¸²à¸‡ AVD
          RUN echo "no" | avdmanager create avd -n test -k "system-images;android-30;google_apis;x86_64" --device "pixel"

          COPY start.sh /start.sh
          RUN chmod +x /start.sh

          EXPOSE 6080
          CMD ["/start.sh"]
          EOF

          # à¹€à¸‚à¸µà¸¢à¸™à¹„à¸Ÿà¸¥à¹Œ start.sh
          cat > cloud-android/start.sh <<'EOF'
          #!/bin/bash
          export DISPLAY=:0
          Xvfb :0 -screen 0 1280x720x16 &
          fluxbox &
          x11vnc -forever -nopw -display :0 -rfbport 5900 &
          websockify --web=/usr/share/novnc/ 6080 localhost:5900 &
          emulator -avd test -noaudio -no-boot-anim -accel on -gpu swiftshader_indirect &
          tail -f /dev/null
          EOF

          # à¹€à¸‚à¸µà¸¢à¸™à¹„à¸Ÿà¸¥à¹Œ docker-compose.yml
          cat > docker-compose.yml <<'EOF'
          version: '3.8'
          services:
            android:
              build: ./cloud-android
              ports:
                - "6080:6080"
            backend:
              image: node:18
              working_dir: /app
              volumes:
                - ./backend:/app
              command: npm start
              ports:
                - "4000:4000"
            frontend:
              build: ./frontend
              ports:
                - "3000:3000"
            mongo:
              image: mongo
              ports:
                - "27017:27017"
          EOF

      - name: Commit & Push
        run: |
          git config --global user.name "autofix-bot"
          git config --global user.email "autofix@users.noreply.github.com"
          git add .
          git commit -m "Auto fix Dockerfile/start.sh/docker-compose" || echo "No changes"
          git push origin main
